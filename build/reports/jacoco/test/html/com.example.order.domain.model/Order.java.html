<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Order.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webflux-reactive-hibernate</a> &gt; <a href="index.source.html" class="el_package">com.example.order.domain.model</a> &gt; <span class="el_source">Order.java</span></div><h1>Order.java</h1><pre class="source lang-java linenums">package com.example.order.domain.model;

import com.example.order.domain.event.DomainEvent;
import com.example.order.domain.event.OrderCancelledEvent;
import com.example.order.domain.event.OrderConfirmedEvent;
import com.example.order.domain.event.OrderCreatedEvent;
import com.example.order.domain.event.OrderPaidEvent;
import com.example.common.domain.valueobject.Email;
import com.example.common.domain.valueobject.Money;
import com.example.order.domain.exception.BusinessException;
import lombok.Getter;

import java.math.BigDecimal;
import java.time.Instant;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.UUID;

@Getter
public class Order {
<span class="fc" id="L22">    private final String id;</span>
<span class="fc" id="L23">    private final String customerId;</span>
<span class="fc" id="L24">    private final Email customerEmail;</span>
    private final List&lt;OrderItem&gt; items;
<span class="fc" id="L26">    private OrderStatus status;</span>
<span class="fc" id="L27">    private Money totalAmount;</span>
<span class="fc" id="L28">    private Money discountAmount;</span>
<span class="fc" id="L29">    private final Instant createdAt;</span>
<span class="fc" id="L30">    private Instant updatedAt;</span>
    private final List&lt;DomainEvent&gt; domainEvents;
    
<span class="fc" id="L33">    private Order(String id, String customerId, Email customerEmail, List&lt;OrderItem&gt; items) {</span>
<span class="fc" id="L34">        this.id = id;</span>
<span class="fc" id="L35">        this.customerId = customerId;</span>
<span class="fc" id="L36">        this.customerEmail = customerEmail;</span>
<span class="fc" id="L37">        this.items = new ArrayList&lt;&gt;(items);</span>
<span class="fc" id="L38">        this.status = OrderStatus.PENDING;</span>
<span class="fc" id="L39">        this.createdAt = Instant.now();</span>
<span class="fc" id="L40">        this.updatedAt = this.createdAt;</span>
<span class="fc" id="L41">        this.domainEvents = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L42">        calculateTotal();</span>
<span class="fc" id="L43">    }</span>

    private Order(String id, String customerId, Email customerEmail, OrderStatus status,
                  List&lt;OrderItem&gt; items, Money totalAmount, Money discountAmount,
<span class="fc" id="L47">                  Instant createdAt, Instant updatedAt) {</span>
<span class="fc" id="L48">        this.id = id;</span>
<span class="fc" id="L49">        this.customerId = customerId;</span>
<span class="fc" id="L50">        this.customerEmail = customerEmail;</span>
<span class="fc" id="L51">        this.items = new ArrayList&lt;&gt;(items);</span>
<span class="fc" id="L52">        this.status = status;</span>
<span class="fc" id="L53">        this.totalAmount = totalAmount;</span>
<span class="fc" id="L54">        this.discountAmount = discountAmount;</span>
<span class="fc" id="L55">        this.createdAt = createdAt;</span>
<span class="fc" id="L56">        this.updatedAt = updatedAt;</span>
<span class="fc" id="L57">        this.domainEvents = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L58">    }</span>
    
    public static Order create(String customerId, Email customerEmail, List&lt;OrderItem&gt; items) {
<span class="fc bfc" id="L61" title="All 4 branches covered.">        if (items == null || items.isEmpty()) {</span>
<span class="fc" id="L62">            throw new BusinessException(&quot;ORDER_001&quot;, &quot;Order must contain at least one item&quot;);</span>
        }
<span class="fc" id="L64">        String orderId = UUID.randomUUID().toString();</span>
<span class="fc" id="L65">        Order order = new Order(orderId, customerId, customerEmail, items);</span>
<span class="fc" id="L66">        Money finalAmount = order.getFinalAmount();</span>
<span class="fc" id="L67">        order.registerEvent(new OrderCreatedEvent(</span>
                orderId,
<span class="fc" id="L69">                customerEmail.getValue(),</span>
                finalAmount,
<span class="fc" id="L71">                order.getCreatedAt()</span>
        ));
<span class="fc" id="L73">        return order;</span>
    }

    public void registerEvent(DomainEvent event) {
<span class="fc" id="L77">        this.domainEvents.add(event);</span>
<span class="fc" id="L78">    }</span>

    public List&lt;DomainEvent&gt; getDomainEvents() {
<span class="fc" id="L81">        return Collections.unmodifiableList(new ArrayList&lt;&gt;(this.domainEvents));</span>
    }

    public void clearDomainEvents() {
<span class="fc" id="L85">        this.domainEvents.clear();</span>
<span class="fc" id="L86">    }</span>
    
    public void applyDiscount(BigDecimal percentage) {
<span class="fc bfc" id="L89" title="All 2 branches covered.">        if (status != OrderStatus.PENDING) {</span>
<span class="fc" id="L90">            throw new BusinessException(&quot;ORDER_002&quot;, &quot;Can only apply discount to pending orders&quot;);</span>
        }
<span class="fc bfc" id="L92" title="All 4 branches covered.">        if (percentage.compareTo(BigDecimal.ZERO) &lt; 0 || percentage.compareTo(BigDecimal.ONE) &gt; 0) {</span>
<span class="fc" id="L93">            throw new BusinessException(&quot;ORDER_003&quot;, &quot;Discount percentage must be between 0 and 1&quot;);</span>
        }
<span class="fc" id="L95">        this.discountAmount = this.totalAmount.discount(percentage);</span>
<span class="fc" id="L96">    }</span>
    
    public void confirm() {
<span class="fc bfc" id="L99" title="All 2 branches covered.">        if (status != OrderStatus.PENDING) {</span>
<span class="fc" id="L100">            throw new BusinessException(&quot;ORDER_004&quot;, &quot;Can only confirm pending orders&quot;);</span>
        }
<span class="fc" id="L102">        this.status = OrderStatus.CONFIRMED;</span>
<span class="fc" id="L103">        this.updatedAt = Instant.now();</span>
<span class="fc" id="L104">        this.registerEvent(new OrderConfirmedEvent(this.id, this.updatedAt));</span>
<span class="fc" id="L105">    }</span>
    
    public void pay() {
<span class="fc bfc" id="L108" title="All 2 branches covered.">        if (status != OrderStatus.CONFIRMED) {</span>
<span class="fc" id="L109">            throw new BusinessException(&quot;ORDER_005&quot;, &quot;Can only pay confirmed orders&quot;);</span>
        }
<span class="fc" id="L111">        this.status = OrderStatus.PAID;</span>
<span class="fc" id="L112">        this.updatedAt = Instant.now();</span>
<span class="fc" id="L113">        this.registerEvent(new OrderPaidEvent(this.id, this.updatedAt));</span>
<span class="fc" id="L114">    }</span>
    
    public void ship() {
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">        if (status != OrderStatus.PAID) {</span>
<span class="nc" id="L118">            throw new BusinessException(&quot;ORDER_006&quot;, &quot;Can only ship paid orders&quot;);</span>
        }
<span class="fc" id="L120">        this.status = OrderStatus.SHIPPED;</span>
<span class="fc" id="L121">        this.updatedAt = Instant.now();</span>
<span class="fc" id="L122">    }</span>
    
    public void deliver() {
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">        if (status != OrderStatus.SHIPPED) {</span>
<span class="nc" id="L126">            throw new BusinessException(&quot;ORDER_007&quot;, &quot;Can only deliver shipped orders&quot;);</span>
        }
<span class="fc" id="L128">        this.status = OrderStatus.DELIVERED;</span>
<span class="fc" id="L129">        this.updatedAt = Instant.now();</span>
<span class="fc" id="L130">    }</span>
    
    public void cancel(String reason) {
<span class="fc bfc" id="L133" title="All 4 branches covered.">        if (status == OrderStatus.SHIPPED || status == OrderStatus.DELIVERED) {</span>
<span class="fc" id="L134">            throw new BusinessException(&quot;ORDER_008&quot;, &quot;Cannot cancel shipped or delivered orders&quot;);</span>
        }
<span class="fc" id="L136">        this.status = OrderStatus.CANCELLED;</span>
<span class="fc" id="L137">        this.updatedAt = Instant.now();</span>
<span class="fc" id="L138">        this.registerEvent(new OrderCancelledEvent(this.id, reason, this.updatedAt));</span>
<span class="fc" id="L139">    }</span>
    
    private void calculateTotal() {
<span class="fc" id="L142">        this.totalAmount = items.stream()</span>
<span class="fc" id="L143">            .map(OrderItem::calculateSubtotal)</span>
<span class="fc" id="L144">            .reduce(Money::add)</span>
<span class="fc" id="L145">            .orElse(Money.zero(&quot;USD&quot;));</span>
<span class="fc" id="L146">    }</span>
    
    public Money getFinalAmount() {
<span class="fc bfc" id="L149" title="All 2 branches covered.">        if (discountAmount != null) {</span>
<span class="fc" id="L150">            return discountAmount;</span>
        }
<span class="fc" id="L152">        return totalAmount;</span>
    }
    
    public int getItemCount() {
<span class="fc" id="L156">        return items.stream().mapToInt(OrderItem::getQuantity).sum();</span>
    }

    public List&lt;OrderItem&gt; getItems() {
<span class="fc" id="L160">        return Collections.unmodifiableList(items);</span>
    }

    public static Order reconstitute(String id, String customerId, Email customerEmail,
                                     OrderStatus status, List&lt;OrderItem&gt; items,
                                     Money totalAmount, Money discountAmount,
                                     Instant createdAt, Instant updatedAt) {
<span class="fc" id="L167">        return new Order(id, customerId, customerEmail, status, items,</span>
                        totalAmount, discountAmount, createdAt, updatedAt);
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>